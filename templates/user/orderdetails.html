{% extends "user/base.html" %}
{% block extra_css %}
  <style>
    body {
      font-family: "Lexend", sans-serif;
      background-color: #f6f8f6;
      color: #1f2937;
    }

    .text-primary-custom { color: #11d452 !important; }
    .bg-primary-custom { background-color: #11d452 !important; }
    .btn-primary-custom {
      background-color: #11d452;
      border-color: #11d452;
      color: #fff;
    }
    .btn-primary-custom:hover {
      background-color: #0fb54a;
      border-color: #0fb54a;
    }

    .material-symbols-outlined {
      font-size: 20px;
      vertical-align: middle;
    }
  </style>
{% endblock %}
{% block content %}
<!-- Main Content -->
<main class="container py-4 py-md-5">

  <!-- Breadcrumbs -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb small">
      <li class="breadcrumb-item"><a href="#">Home</a></li>
      <li class="breadcrumb-item"><a href="#">Orders</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{order.id}}</li>
    </ol>
  </nav>

  <!-- Page Heading -->
  <div class="d-flex flex-wrap justify-content-between align-items-start mb-4">
    <div>
      <h1 class="fw-bold">Order Details</h1>
      <p class="text-muted small">Order ID: {{order.id}}</p>
    </div>
    <span class="badge rounded-pill bg-warning-subtle text-warning-emphasis px-3 py-2">
      {{order.status}}
    </span>  
    <a href="{%url 'download_invoice' order.id%}" class="btn btn-outline-dark btn-sm">
      <span class="material-symbols-outlined me-1">download</span>
      Invoice
    </a>
  </div>

  <div class="row g-4">
    <!-- Left Column -->
    <div class="col-lg-8">

      <!-- Order Summary -->
      <div class="card mb-4">
        <div class="card-header bg-white fw-bold">Order Summary</div>
        <div class="card-body">
          <div class="row small g-3">
            <div class="col-sm-6">
              <div class="d-flex justify-content-between flex-sm-column">
                <span class="text-muted">Order Date</span>
                <strong>{{order.created_at|date:"F d, Y"}}</strong>
              </div>
            </div>
            <div class="col-sm-6">
              <div class="d-flex justify-content-between flex-sm-column">
                <span class="text-muted">Payment Method</span>
                <strong>{{ order.get_payment_method_display }}</strong>
              </div>
            </div>
            <div class="col-sm-6">
              <div class="d-flex justify-content-between flex-sm-column">
                <span class="text-muted">Payment Status</span>
                <strong>{{order.status}}</strong>
              </div>
            </div>
            <div class="col-sm-6">
              <div class="d-flex justify-content-between flex-sm-column">
                <span class="text-muted">Estimated Delivery</span>
                <strong>{{estimated_delivery|date:"M d, Y"}}</strong>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Items -->
        <ul class="list-group list-group-flush">
             {%for item in order_items%}
          <li class="list-group-item">
            <div class="d-flex flex-column flex-sm-row gap-3">
              <img src="{{item.product.main_img.url}}"
                   class="rounded" width="120" height="120" style="object-fit:cover;">
              <div class="flex-grow-1 d-flex flex-column justify-content-between">
                <div class="d-flex justify-content-between">
                  <div>
                    <h6 class="fw-semibold mb-1 text-muted">{{item.product}}</h6>
                    {%if item.variant%}
                    <div class="text-muted small">
                      Size:{{item.variant.get_size_display}}
                    </div>
                    {%endif%}
                    <div class="text-muted small">Qty: {{item.quantity}}</div>
                  </div>
                  <div class="fw-semibold">Rs.{{item.price}}</div>
                </div>
                <div class="mt-2">
                    {%if order.status == 'delivered'%}
                    {%if item.return_status == 'none'%}
                    <button class="btn btn-outline-danger btn-sm" type="button" onclick="document.getElementById('return-form-{{ item.id }}').classList.toggle('d-none')">
                        Return Item
                    </button>
                    <form method="post" action="{%url 'return_item' item.id%}" id="return-form-{{item.id}}" class="mt-2 d-none">
                        {%csrf_token%}
                        <div class="mb-2">
                            <label class="form-label small">Reason for return</label>
                            <select name="reason" class="form-select form-select-sm" required>
                                <option value="">Select a reason</option>
                                <option value="damaged">Item was damaged</option> 
                                <option value="wrong_item">Wrong item received</option>
                                <option value="size_issue">Size/Fit issue</option>
                                <option value="not_as_described">Not as described</option> 
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Additional details(optional)</label>  
                            <textarea name="notes" rows="2" class="form-control form-control-sm" placeholder="descibe the issue..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-danger btn-sm">
                            Submit Return
                        </button>
                    </form>
                    {%else%}
                    {% if item.return_status == 'requested' %}
                    <span class="badge bg-secondary">Return Requested</span>
                    {%if item.return_reason%} 
                    <p class="text-muted small mt-1">
                        Reason:{{item.return_reason}}
                    </p>
                    {%endif%}
                    {% elif item.return_status == 'approved' %}
                    <span class="badge bg-success">Return Approved</span>
                    <p class="text-muted small mt-1">
                      Your return request has been approved
                    </p> 
                    {% elif item.return_status == 'refunded' %}
                    <span class="badge bg-info">Amount Refunded</span>
                    <p class="text-muted small mt-1">
                      The amount has been successfully refunded
                    </p> 
                    {% elif item.return_status == 'rejected' %}
                    <span class="badge bg-danger">Return Rejected</span>
                    <p class="text-muted small mt-1">
                      Sorry, your request has been rejected
                    </p> 
                    {% endif %}
                    {%endif%} 
                    {%else%}
                    <span class="text-muted small">Return available after delivery</span>
                    {%endif%} 
                    {% if order.status == 'pending' or order.status == 'paid' %}
                    {% if not item.cancelled %}
                    <form method="post" action="{% url 'cancel_order_item' item.id %}" class="mt-2">
                      {% csrf_token %}
                      <button class="btn btn-outline-danger btn-sm">
                        Cancel Item
                      </button>
                    </form> 
                    {% else %} 
                    <span class="badge bg-danger mt-2">Item Cancelled</span>
                    {% endif %}
                    {% endif %}
                </div>
                <button class="btn btn-link text-primary-custom p-0 mt-2">Buy Again</button>
              </div>
            </div>
          </li>
          {%empty%} 
          <li class="list-group-item text-center text-muted">
            No items in this order
          </li> 
          {%endfor%}
        </ul>

        <!-- Price Breakdown -->
        <div class="card-body border-top">
          <div class="d-flex justify-content-between small mb-2">
            <span class="text-muted">Subtotal</span>
            <strong>Rs.{{subtotal}}</strong>
          </div>
          <div class="d-flex justify-content-between small mb-2">
            <span class="text-muted">Shipping</span>
            <strong>Rs.{{shipping}}</strong>
          </div>
          <div class="d-flex justify-content-between small mb-2">
            <span class="text-muted">Tax</span>
            <strong>Rs.{{tax}}</strong>
          </div>
          <hr>
          <div class="d-flex justify-content-between fs-5 fw-bold">
            <span>Grand Total</span>
            <span class="text-primary-custom">Rs.{{grand_total}}</span>
          </div>
        </div>
      </div>

      <!-- Cancel Order -->
      <div class="card border-danger">
        <div class="card-body d-flex flex-column flex-sm-row justify-content-between gap-3">
          <div>
            <h6 class="fw-semibold">Need to cancel your order?</h6>
            <p class="small text-muted mb-0">Orders can only be cancelled before they are shipped.</p>
          </div>
          {%if order.status == 'pending' or order.status == 'paid'%} 
          <form method="post" action="{%url 'cancel_order' order.id%}">
            {%csrf_token%}
          <button class="btn btn-danger">Cancel Order</button> 
          </form> 
          {%else%}
          <p class="text-muted small">This order can no longer be cancelled</p>
          {%endif%}
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header bg-white fw-bold">Shipping & Billing</div>
        <div class="card-body small">
          <h6 class="fw-semibold">Shipping Address</h6>
          <address class="text-muted">
            {{order.address|linebreaksbr}}
          </address>

          <h6 class="fw-semibold mt-3">Billing Address</h6>
          <p class="text-muted">Same as shipping address</p>

          <h6 class="fw-semibold mt-3">Delivery Method</h6>
          <p class="text-muted">{{order.delivery_type}}</p>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <h6 class="fw-semibold">Need help?</h6>
          <p class="small text-muted">If you have any questions about your order, we're here to help.</p>
          <div class="d-grid gap-2 d-sm-flex">
            <a href="{% url 'contact' %}" class="btn btn-outline-success">Contact Support</a>
            <a href="{% url 'faq' %}" class="btn btn-outline-secondary">View FAQ</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  
</main>
{% endblock %}
