<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add New Product – Admin</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.css">

  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #f8f8f6;
    }

    .sidebar {
      width: 260px;
      min-height: 100vh;
      background: #fff;
      border-right: 1px solid #e6e4db;
    }

    .sidebar a {
      text-decoration: none;
      color: #181711;
      padding: 10px 14px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
    }

    .sidebar a:hover {
      background: rgba(0,0,0,.05);
    }

    .sidebar .active {
      background: rgba(236,200,19,.25);
    }

    .avatar {
      width: 40px;
      height: 40px;
      background-size: cover;
      background-position: center;
      border-radius: 50%;
    }

    .upload-box {
      border: 2px dashed #e6e4db;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      background: #f8f8f6;
    }

    .price-prefix {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #898361;
    }

    .ps-price {
      padding-left: 32px;
    }
  </style>
</head>

<body> 
  <form method="post" id="addProductForm" enctype="multipart/form-data">
    {%csrf_token%}        
<div class="d-flex">

  <!-- Sidebar -->
  <aside class="sidebar p-4 d-flex flex-column">
    <div class="d-flex align-items-center gap-3 mb-4">
      <div class="avatar"
        style="background-image:url('https://lh3.googleusercontent.com/aida-public/AB6AXuCPiWllXhA6wiGknM4WV3maMgcaPTwANQR4rlMPj39sS4VRcduNX4a3yBfPcFaNPgOSIsFVV3WRxAq0OIVgfvOPkKaXUXOe8XRAFTZIj63FHDM2jb9a1nWdedjnNO93JcSmDpwZoSBltyapuN-bX2XjSgeAnZ6ZR_5oGG7-lVrrxx8Ply6V-sBstIApodEb8UzPVhEIH7iEfSzzFJqTGntUVXMa0q5ZGHJX0ctXc-9A6p_ENkH7uykM7PmVUTC0b7gzYYn1QD3MSSs');">
      </div>
      <div>
        <strong>Admin</strong>
        <div class="text-muted small">admin@retrojerseys.com</div>
      </div>
    </div>

    <nav class="d-flex flex-column gap-2">
      <a href="#"><span class="material-symbols-outlined">dashboard</span>Dashboard</a>
      <a href="#" class="active"><span class="material-symbols-outlined">inventory_2</span>Products</a>
      <a href="#"><span class="material-symbols-outlined">receipt_long</span>Orders</a>
      <a href="#"><span class="material-symbols-outlined">group</span>Customers</a>
      <a href="#"><span class="material-symbols-outlined">bar_chart</span>Analytics</a>
    </nav>

    <div class="mt-auto">
      <a href="#"><span class="material-symbols-outlined">settings</span>Settings</a>
      <a href="#"><span class="material-symbols-outlined">logout</span>Logout</a>
    </div>
  </aside>

  {% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}

  <!-- Main Content -->
  <main class="flex-fill p-4 p-lg-5">

    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
      <h1 class="fw-black display-6">Add New Product</h1>
      <div class="d-flex gap-2">
        <a href="{%url 'product_list'%}" class="btn btn-outline-secondary">Cancel</a>
        <button type="submit" class="btn btn-warning fw-semibold" form="addProductForm" formnovalidate>Save Product</button>
      </div>
    </div>

    <div class="row g-4">

      <!-- Left Column -->
      <div class="col-lg-8">

        <!-- Basic Info -->
        <div class="card mb-4">
          <div class="card-header fw-bold">Basic Information</div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Team</label>            
              <input class="form-control" name="team" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Season</label>            
              <input class="form-control" name="season" required>
            </div> 
            <div class="mb-3">
              <label class="form-label">Player Name</label>            
              <input class="form-control" name="player_name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Slug(URL)</label>            
              <input class="form-control" name="slug" id="slugInput" placeholder="auto-generated-from-team-player-season"> 
              <small class="text-muted">
                Leave empty to auto-generate
              </small>
            </div>
            <div>
              <label class="form-label">Full Description</label>
              <textarea class="form-control" name="description" rows="5" required></textarea>
            </div>
          </div>
        </div>

        <!-- Media -->
        <div class="card mb-4">
          <div class="card-header fw-bold">Media</div>
          <div class="card-body">
            <div class="card-body">
              <label class="form-label">Product Images(Upload 3)</label>
              <input type="file" id="imageInput" name="images" multiple class="form-control" accept="image/*" required>
              <small class="text-muted d-block mt-2">Upload exactly 3 images. Choose one as main.</small>
              <div id="imagePreview" class="row g-3 mt-2"></div>
              <input type="hidden" name="main_index" id="mainIndex" value="0">
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="card">
          <div class="card-header fw-bold d-flex justify-content-between">
            Variants
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addVariantRow()">
              + Add Variant
            </button>
          </div>
          <div class="card-body">
            <table class="table align-middle" id="variantTable">
              <thead>
                <tr>
                  <th>Size</th>
                  <th>Price</th>
                  <th>Stock</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <select name="sizes[]" class="form-select" required>
                      <option value="S">Small</option>
                      <option value="M">Medium</option>
                      <option value="L">Large</option>
                    </select> 
                  </td>
                  <td>
                    <input type="number" name="prices[]" class="form-control" step="0.01" required>
                  </td>
                  <td>
                    <input type="number" name="stocks[]" class="form-control" required>
                  </td>
                  <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">X</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="col-lg-4">

        <!-- Organization -->
        <div class="card mb-4">
          <div class="card-header fw-bold">Organization</div>
          <div class="card-body"> 
            <div class="mb-3 form-check">
              <input type="checkbox" name="is_featured" class="form-check-input" id="isFeaturedCheck">
              <label for="isFeaturedCheck" class="form-check-label fw-semibold">
                Feature this product on home page
              </label>
              <small class="text-muted d-block">
                Manually highlight this product in Featured section
              </small>
            </div>
            <div class="mb-3">
              <label class="form-label">Category</label>
              <select name="category" class="form-select" required>  
                {%for category in categories%}
                <option value="{{category.id}}">{{category.name}}</option>
                {%endfor%}
              </select>
            </div>
          </div>
      </div>
    </div>
    </div>
  </main>
</div>
  </form>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.js"></script>
<script>
let cropper;
let selectedIndex = 0;
const input = document.getElementById('imageInput');
const preview = document.getElementById('imagePreview');
const mainIndexInput = document.getElementById('mainIndex');

input.addEventListener('change', function () {
  preview.innerHTML = '';
  const files = Array.from(this.files);

  if (files.length !== 3) {
    alert("Please upload exactly 3 images.");
    input.value = '';
    return;
  }

  files.forEach((file, index) => {
    const reader = new FileReader();

    reader.onload = function (e) {
      const col = document.createElement('div');
      col.className = 'col-4';

      col.innerHTML = `
        <div class="border p-2 rounded text-center">
          <img src="${e.target.result}" 
     id="img-${index}" 
     class="img-fluid rounded mb-2" 
     style="width:100%; height:auto; cursor:pointer;">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="main_select" value="${index}" ${index === 0 ? 'checked' : ''}>
            <label class="form-check-label small">Set as Main</label>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="startCrop(${index})">Crop</button> 
          <button type="button" class="btn btn-sm btn-success mt-1 d-none" id="apply-${index}" onclick="applyCrop(${index})">Apply Crop</button>
        </div>
      `;

      preview.appendChild(col);
    };

    reader.readAsDataURL(file);
  });
});

// Track selected main image
document.addEventListener('change', function (e) {
  if (e.target.name === 'main_select') {
    selectedIndex = e.target.value;
    mainIndexInput.value = selectedIndex;
  }
});

// Crop Function
function startCrop(index) {
  const img = document.getElementById(`img-${index}`);
  const applyBtn = document.getElementById(`apply-${index}`);

  if (cropper) cropper.destroy();

  cropper = new Cropper(img, {
    aspectRatio: 4 / 5,
    viewMode: 1,
    autoCropArea: 1,
    background: false
  });

  applyBtn.classList.remove("d-none");
}

function applyCrop(index) {
  if (!cropper) return;

  const img = document.getElementById(`img-${index}`);

  const canvas = cropper.getCroppedCanvas({
    width: 800,
    height: 1000,
    imageSmoothingQuality: "high"
  });

  const croppedDataURL = canvas.toDataURL("image/jpeg");

  // ✅ Update preview
  img.src = croppedDataURL;

  canvas.toBlob(function (blob) {
    const croppedFile = new File([blob], `cropped_${index}.jpg`, { type: "image/jpeg" });

    // ✅ Replace file in input
    const dt = new DataTransfer();
    const files = Array.from(input.files);
    files[index] = croppedFile;
    files.forEach(f => dt.items.add(f));
    input.files = dt.files;

    cropper.destroy();
    cropper = null;

    alert("Image cropped successfully!");
  });
}


</script>
<script>
function addVariantRow() {
  const tbody = document.querySelector('#variantTable tbody');
  const row = document.createElement('tr');

  row.innerHTML = `
    <td>
      <select name="sizes[]" class="form-select" required>
        <option value="S">Small</option>
        <option value="M">Medium</option>
        <option value="L">Large</option>
      </select>
    </td>
    <td>
      <input type="number" name="prices[]" class="form-control" step="0.01" required>
    </td>
    <td>
      <input type="number" name="stocks[]" class="form-control" required>
    </td>
    <td>
      <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">✕</button>
    </td>
  `;

  tbody.appendChild(row);
}

function removeRow(btn) {
  const tbody = document.querySelector('#variantTable tbody');
  if (tbody.children.length === 1) {
    alert("At least one variant is required.");
    return;
  }
  btn.closest('tr').remove();
}
</script>
<script>
function slugify(text) {
  return text
    .toString()
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '-')
    .replace(/[^\w\-]+/g, '')
    .replace(/\-\-+/g, '-');
}

function updateSlug() {
  const team = document.querySelector('input[name="team"]').value;
  const player = document.querySelector('input[name="player_name"]').value;
  const season = document.querySelector('input[name="season"]').value;

  const slugInput = document.getElementById('slugInput');

  if (!slugInput.value) {
    slugInput.value = slugify(`${team}-${player}-${season}`);
  }
}

document.querySelector('input[name="team"]').addEventListener('input', updateSlug);
document.querySelector('input[name="player_name"]').addEventListener('input', updateSlug);
document.querySelector('input[name="season"]').addEventListener('input', updateSlug);
</script>
</body>
</html>